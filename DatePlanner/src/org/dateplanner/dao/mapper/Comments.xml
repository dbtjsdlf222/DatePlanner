<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.dateplanner.dao.CommentsDAO">
  
  <insert id="insertComment" parameterType="Comment">
    INSERT INTO comments
      (no, board_no, user_no, content)
    VALUES
      ((SELECT IFNULL(MAX(no), 0)+1 FROM comments c), #{boardNo}, #{user.no}, #{content})
  </insert>
  
  <insert id="insertReply" parameterType="Comment">
    INSERT INTO comments
      (no, `order`, board_no, user_no, content)
    VALUES
      (#{no}, (SELECT IFNULL(MAX(`order`), 0)+1 FROM comments c WHERE no = #{no}), #{boardNo}, #{user.no}, #{content})
  </insert>  

  <select id="selectByBoardNo" parameterType="int" resultType="Comment">
	SELECT
      c.no, `order`, board_no, content, c.regdate, u.no 'user.no', u.nickname 'user.nickname'
    FROM
      comments c
    JOIN
      users u
    ON
      user_no = u.no
    WHERE
      board_no = #{boardNo}
    ORDER BY c.no DESC, `order` DESC
    LIMIT #{page.startContent}, #{page.contentCount}
  </select>
  
  <select id="selectCount" parameterType="int" resultType="int">
	SELECT
      COUNT(*)
    FROM
      comments
    WHERE
      board_no = #{boardNo}
  </select>
  
  <update id="update">
    UPDATE
      comments
    SET
      content = #{content}
    WHERE 
      order = `#{orderNo}`
  	  AND
  	  no = #{no}
  </update>
  
  <delete id="delete" parameterType="String">
    DELETE FROM comment
    WHERE 
      order = `#{orderNo}`
  	  AND
  	  no = #{no}
  </delete>
</mapper>